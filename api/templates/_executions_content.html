{% if not is_embedded %}
{# No wrapper needed for partial templates #}
{% endif %}
<style>
    .dropdown-item:hover {
        background-color: #f5f5f5;
    }

    .dropdown-menu {
        animation: fadeIn 0.15s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-4px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    console.log('=== EXECUTIONS PAGE DEBUG ===');
</script>

{% if is_embedded %}
<div class="card-header">
    <h2>Recent Executions</h2>
</div>
{% else %}
<div class="card" hx-get="/dashboard/executions" hx-trigger="sse:execution_status_changed" hx-select=".card"
    hx-swap="outerHTML">
    <div class="card-header">
        <h2>Execution History</h2>
    </div>

    <!-- Search Filters -->
    <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
                <label for="job-name-filter"
                    style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: 500; color: #555;">Job
                    Name</label>
                <input type="text" id="job-name-filter" placeholder="Search by job name..."
                    value="{{ job_name_filter }}"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;"
                    onkeyup="if(event.key === 'Enter') filterExecutions()" />
            </div>

            <div>
                <label for="status-filter"
                    style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: 500; color: #555;">Status</label>
                <select id="status-filter" onchange="filterExecutions()"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                    <option value="">All Statuses</option>
                    <option value="pending" {% if status_filter=="pending" %}selected{% endif %}>Pending</option>
                    <option value="running" {% if status_filter=="running" %}selected{% endif %}>Running</option>
                    <option value="success" {% if status_filter=="success" %}selected{% endif %}>Success</option>
                    <option value="failed" {% if status_filter=="failed" %}selected{% endif %}>Failed</option>
                    <option value="timeout" {% if status_filter=="timeout" %}selected{% endif %}>Timeout</option>
                    <option value="cancelling" {% if status_filter=="cancelling" %}selected{% endif %}>Cancelling
                    </option>
                    <option value="cancelled" {% if status_filter=="cancelled" %}selected{% endif %}>Cancelled</option>
                    <option value="dead_letter" {% if status_filter=="dead_letter" %}selected{% endif %}>Dead Letter
                    </option>
                </select>
            </div>

            <div>
                <label for="trigger-source-filter"
                    style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: 500; color: #555;">Trigger
                    Source</label>
                <select id="trigger-source-filter" onchange="filterExecutions()"
                    style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                    <option value="">All Sources</option>
                    <option value="scheduled" {% if trigger_source_filter=="scheduled" %}selected{% endif %}>‚è∞ Scheduled
                    </option>
                    <option value="manual" {% if trigger_source_filter=="manual" %}selected{% endif %}>üë§ Manual
                    </option>
                    <option value="webhook" {% if trigger_source_filter=="webhook" %}selected{% endif %}>üîó Webhook
                    </option>
                </select>
            </div>

            <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
                <button class="btn btn-primary" onclick="filterExecutions()"
                    style="flex: 1; padding: 0.5rem 1rem; font-size: 0.9rem;">
                    üîç Search
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()"
                    style="flex: 1; padding: 0.5rem 1rem; font-size: 0.9rem;">
                    ‚úï Clear
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    {% if executions %}
    <table>
        <thead>
            <tr>
                <th style="width: 60px;">#</th>
                <th>Job Name</th>
                <th>Status</th>
                <th>Trigger Source</th>
                <th>Started At</th>
                <th>Duration</th>
                <th>Attempt</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for execution in executions %}
            <tr>
                <td style="text-align: center; font-weight: 500; color: #666;">{{ offset + loop.index }}</td>
                <td>
                    <a href="/dashboard/jobs/{{ execution.job_id }}" hx-get="/dashboard/jobs/{{ execution.job_id }}"
                        hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"
                        style="color: #3498db; text-decoration: none;">
                        {{ execution.job_name | default(value="Unknown") }}
                    </a>
                </td>
                <td>
                    {% if execution.status == "running" %}
                    <span class="badge badge-primary">Running</span>
                    {% elif execution.status == "success" %}
                    <span class="badge badge-success">Success</span>
                    {% elif execution.status == "failed" %}
                    <span class="badge badge-error">Failed</span>
                    {% elif execution.status == "pending" %}
                    <span class="badge badge-secondary">Pending</span>
                    {% elif execution.status == "cancelling" %}
                    <span class="badge badge-warning">Cancelling</span>
                    {% elif execution.status == "cancelled" %}
                    <span class="badge badge-error">Cancelled</span>
                    {% elif execution.status == "timeout" %}
                    <span class="badge badge-error">Timeout</span>
                    {% elif execution.status == "dead_letter" %}
                    <span class="badge badge-error">Dead Letter</span>
                    {% else %}
                    <span class="badge badge-secondary">{{ execution.status }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if execution.trigger_source == "scheduled" %}
                    <span class="badge badge-info">‚è∞ Scheduled</span>
                    {% elif execution.trigger_source == "manual" %}
                    <span class="badge badge-primary">üë§ Manual</span>
                    {% elif execution.trigger_source == "webhook" %}
                    <span class="badge badge-warning">üîó Webhook</span>
                    {% else %}
                    <span class="badge badge-secondary">{{ execution.trigger_source }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if execution.started_at %}
                    <small>{{ execution.started_at }}</small>
                    {% else %}
                    <small>-</small>
                    {% endif %}
                </td>
                <td>
                    {% if execution.duration_seconds %}
                    {% if execution.duration_seconds < 60 %} <small>{{ execution.duration_seconds }}s</small>
                        {% elif execution.duration_seconds < 3600 %} <small>{{ (execution.duration_seconds / 60) |
                            round
                            }}m</small>
                            {% else %}
                            <small>{{ (execution.duration_seconds / 3600) | round }}h</small>
                            {% endif %}
                            {% elif execution.status == "running" %}
                            <small class="badge badge-info">Running...</small>
                            {% else %}
                            <small>-</small>
                            {% endif %}
                </td>
                <td>
                    {% if execution.attempt > 1 %}
                    <span class="badge badge-warning">{{ execution.attempt }}</span>
                    {% else %}
                    {{ execution.attempt }}
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-sm btn-secondary" onclick="showExecutionDetails('{{ execution.id }}')">
                            Details
                        </button>
                        {% if execution.status == "running" %}
                        <div class="dropdown" style="position: relative;">
                            <button class="btn btn-sm btn-error" onclick="toggleStopMenu('{{ execution.id }}')"
                                id="stop-btn-{{ execution.id }}">
                                ‚èπ Stop
                            </button>
                            <div id="stop-menu-{{ execution.id }}" class="dropdown-menu"
                                style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000; min-width: 180px; margin-top: 4px;">
                                <button class="dropdown-item" onclick="stopExecution('{{ execution.id }}', false)"
                                    style="display: block; width: 100%; padding: 8px 12px; text-align: left; border: none; background: none; cursor: pointer; font-size: 0.9rem;">
                                    üõë Stop Gracefully
                                </button>
                                <button class="dropdown-item" onclick="stopExecution('{{ execution.id }}', true)"
                                    style="display: block; width: 100%; padding: 8px 12px; text-align: left; border: none; background: none; cursor: pointer; font-size: 0.9rem; color: #e74c3c;">
                                    ‚ö†Ô∏è Stop Immediately
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if total_pages > 1 %}
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding: 1rem; border-top: 1px solid #e0e0e0;">
        <div style="color: #666; font-size: 0.9rem;">
            Showing {{ executions | length }} of {{ total_count }} executions (Page {{ page }} of {{ total_pages }})
        </div>
        <div style="display: flex; gap: 0.5rem;">
            {% if page > 1 %}
            <button class="btn btn-secondary btn-sm"
                hx-get="/dashboard/executions?offset=0&limit={{ limit }}{% if job_id_filter %}&job_id={{ job_id_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if trigger_source_filter %}&trigger_source={{ trigger_source_filter }}{% endif %}{% if job_name_filter %}&job_name={{ job_name_filter }}{% endif %}"
                {% if is_embedded %}hx-target="closest .card" {% else %}hx-target="#main-content" {% endif %}
                hx-swap="innerHTML">
                ¬´ First
            </button>
            <button class="btn btn-secondary btn-sm"
                hx-get="/dashboard/executions?offset={{ (page - 2) * limit }}&limit={{ limit }}{% if job_id_filter %}&job_id={{ job_id_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if trigger_source_filter %}&trigger_source={{ trigger_source_filter }}{% endif %}{% if job_name_filter %}&job_name={{ job_name_filter }}{% endif %}"
                {% if is_embedded %}hx-target="closest .card" {% else %}hx-target="#main-content" {% endif %}
                hx-swap="innerHTML">
                ‚Äπ Previous
            </button>
            {% else %}
            <button class="btn btn-secondary btn-sm" disabled style="opacity: 0.5; cursor: not-allowed;">
                ¬´ First
            </button>
            <button class="btn btn-secondary btn-sm" disabled style="opacity: 0.5; cursor: not-allowed;">
                ‚Äπ Previous
            </button>
            {% endif %}

            <span style="padding: 0.5rem 1rem; background: #f5f5f5; border-radius: 4px; font-weight: 500;">
                {{ page }} / {{ total_pages }}
            </span>

            {% if page < total_pages %} <button class="btn btn-secondary btn-sm"
                hx-get="/dashboard/executions?offset={{ page * limit }}&limit={{ limit }}{% if job_id_filter %}&job_id={{ job_id_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if trigger_source_filter %}&trigger_source={{ trigger_source_filter }}{% endif %}{% if job_name_filter %}&job_name={{ job_name_filter }}{% endif %}"
                {% if is_embedded %}hx-target="closest .card" {% else %}hx-target="#main-content" {% endif %}
                hx-swap="innerHTML">
                Next ‚Ä∫
                </button>
                <button class="btn btn-secondary btn-sm"
                    hx-get="/dashboard/executions?offset={{ (total_pages - 1) * limit }}&limit={{ limit }}{% if job_id_filter %}&job_id={{ job_id_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if trigger_source_filter %}&trigger_source={{ trigger_source_filter }}{% endif %}{% if job_name_filter %}&job_name={{ job_name_filter }}{% endif %}"
                    {% if is_embedded %}hx-target="closest .card" {% else %}hx-target="#main-content" {% endif %}
                    hx-swap="innerHTML">
                    Last ¬ª
                </button>
                {% else %}
                <button class="btn btn-secondary btn-sm" disabled style="opacity: 0.5; cursor: not-allowed;">
                    Next ‚Ä∫
                </button>
                <button class="btn btn-secondary btn-sm" disabled style="opacity: 0.5; cursor: not-allowed;">
                    Last ¬ª
                </button>
                {% endif %}
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
        </svg>
        <h3>No executions found</h3>
        <p>Execution history will appear here once jobs start running</p>
    </div>
    {% endif %}

    <!-- Execution Details Modal -->
    <div id="execution-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 2rem;">
        <div
            style="max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; padding: 2rem; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Execution Details</h2>
                <button onclick="closeExecutionDetails()"
                    style="border: none; background: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div id="execution-details-content">
                Loading...
            </div>
        </div>
    </div>

    <script>
        function filterExecutions() {
            const jobName = document.getElementById('job-name-filter')?.value || '';
            const status = document.getElementById('status-filter')?.value || '';
            const triggerSource = document.getElementById('trigger-source-filter')?.value || '';

            const params = new URLSearchParams();
            if (jobName) params.append('job_name', jobName);
            if (status) params.append('status', status);
            if (triggerSource) params.append('trigger_source', triggerSource);

            const url = `/dashboard/executions${params.toString() ? '?' + params.toString() : ''}`;
            htmx.ajax('GET', url, { target: '#main-content', swap: 'innerHTML' });
        }

        function clearFilters() {
            if (document.getElementById('job-name-filter')) {
                document.getElementById('job-name-filter').value = '';
            }
            if (document.getElementById('status-filter')) {
                document.getElementById('status-filter').value = '';
            }
            if (document.getElementById('trigger-source-filter')) {
                document.getElementById('trigger-source-filter').value = '';
            }
            htmx.ajax('GET', '/dashboard/executions', { target: '#main-content', swap: 'innerHTML' });
        }

        function showExecutionDetails(executionId) {
            document.getElementById('execution-modal').style.display = 'block';
            htmx.ajax('GET', `/api/executions/${executionId}`, {
                target: '#execution-details-content',
                swap: 'innerHTML'
            });
        }

        function closeExecutionDetails() {
            document.getElementById('execution-modal').style.display = 'none';
        }

        function toggleStopMenu(executionId) {
            const menu = document.getElementById(`stop-menu-${executionId}`);
            // Close all other menus
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m.id !== `stop-menu-${executionId}`) {
                    m.style.display = 'none';
                }
            });
            // Toggle current menu
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function stopExecution(executionId, force) {
            const action = force ? 'stop immediately' : 'stop gracefully';
            const message = force
                ? 'Are you sure you want to FORCE STOP this execution? It will terminate immediately without completing the current step.'
                : 'Are you sure you want to stop this execution? It will complete the current step and then stop.';

            if (!confirm(message)) {
                return;
            }

            // Close dropdown menu
            document.getElementById(`stop-menu-${executionId}`).style.display = 'none';

            // Call API to stop execution
            fetch(`/api/executions/${executionId}/stop?force=${force}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Failed to stop execution');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Execution stop requested:', data);
                    // Refresh executions list
                    htmx.ajax('GET', '/dashboard/executions', { target: '#main-content', swap: 'innerHTML' });
                })
                .catch(error => {
                    console.error('Error stopping execution:', error);
                    alert(`Failed to ${action}: ${error.message}`);
                });
        }

        // Close dropdown menus when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
        });
    </script>