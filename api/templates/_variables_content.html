<script>
    console.log('=== VARIABLES PAGE DEBUG ===');
    console.log('Variables:', {{ variables | json_encode() | safe }});
    console.log('Total variables:', {{ variables | length }});
    console.log('===========================');
</script>

<div class="card">
    <div class="card-header">
        <h2>Variables</h2>
        <button class="btn btn-primary" onclick="showCreateVariableForm()">
            + Create Variable
        </button>
    </div>

    {% if variables %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Scope</th>
                <th>Value</th>
                <th>Sensitive</th>
                <th>Updated At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for variable in variables %}
            <tr>
                <td><strong>{{ variable.name }}</strong></td>
                <td>
                    {% if variable.scope_type == "Global" %}
                    <span class="badge badge-info">Global</span>
                    {% else %}
                    <span class="badge badge-secondary">Job-Specific</span>
                    {% endif %}
                </td>
                <td>
                    {% if variable.is_sensitive %}
                    <code>********</code>
                    {% else %}
                    <code>{{ variable.value | truncate(length=50) }}</code>
                    {% endif %}
                </td>
                <td>
                    {% if variable.is_sensitive %}
                    <span class="badge badge-warning">ðŸ”’ Yes</span>
                    {% else %}
                    <span class="badge badge-secondary">No</span>
                    {% endif %}
                </td>
                <td><small>{{ variable.updated_at }}</small></td>
                <td>
                    <button class="btn btn-sm btn-secondary"
                        onclick="editVariable('{{ variable.id }}', '{{ variable.name }}', '{{ variable.value }}', {{ variable.is_sensitive | lower }})">
                        Edit
                    </button>
                    <button class="btn btn-sm btn-danger" hx-delete="/api/variables/{{ variable.id }}"
                        hx-confirm="Delete variable '{{ variable.name }}'?" hx-target="closest tr"
                        hx-swap="outerHTML swap:1s">
                        Delete
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if total_pages > 1 %}
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding: 1rem; border-top: 1px solid #e0e0e0;">
        <div style="color: #666; font-size: 0.9rem;">
            Showing {{ variables | length }} of {{ total_count }} variables (Page {{ page }} of {{ total_pages }})
        </div>
        <div style="display: flex; gap: 0.5rem;">
            {% if page > 1 %}
            <button class="btn btn-secondary btn-sm" hx-get="/dashboard/variables?offset=0&limit={{ limit }}"
                hx-target="#main-content" hx-swap="innerHTML">
                Â« First
            </button>
            <button class="btn btn-secondary btn-sm"
                hx-get="/dashboard/variables?offset={{ (page - 2) * limit }}&limit={{ limit }}"
                hx-target="#main-content" hx-swap="innerHTML">
                â€¹ Previous
            </button>
            {% else %}
            <button class="btn btn-secondary btn-sm" disabled style="opacity: 0.5; cursor: not-allowed;">
                Â« First
            </button>
            <button class="btn btn-secondary btn-sm" disabled style="opacity: 0.5; cursor: not-allowed;">
                â€¹ Previous
            </button>
            {% endif %}

            <span style="padding: 0.5rem 1rem; background: #f5f5f5; border-radius: 4px; font-weight: 500;">
                {{ page }} / {{ total_pages }}
            </span>

            {% if page < total_pages %} <button class="btn btn-secondary btn-sm"
                hx-get="/dashboard/variables?offset={{ page * limit }}&limit={{ limit }}" hx-target="#main-content"
                hx-swap="innerHTML">
                Next â€º
                </button>
                <button class="btn btn-secondary btn-sm"
                    hx-get="/dashboard/variables?offset={{ (total_pages - 1) * limit }}&limit={{ limit }}"
                    hx-target="#main-content" hx-swap="innerHTML">
                    Last Â»
                </button>
                {% else %}
                <button class="btn btn-secondary btn-sm" disabled style="opacity: 0.5; cursor: not-allowed;">
                    Next â€º
                </button>
                <button class="btn btn-secondary btn-sm" disabled style="opacity: 0.5; cursor: not-allowed;">
                    Last Â»
                </button>
                {% endif %}
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
        </svg>
        <h3>No variables found</h3>
        <p>Create variables to use in your job configurations</p>
    </div>
    {% endif %}
</div>

<!-- Create/Edit Variable Modal -->
<div id="variable-modal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; padding: 2rem;">
    <div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 8px; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 id="modal-title">Create Variable</h2>
            <button onclick="closeVariableModal()"
                style="border: none; background: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>

        <form id="variable-form" hx-post="/api/variables" hx-target="#main-content" hx-swap="innerHTML">
            <input type="hidden" id="variable-id" name="id">

            <div class="form-group">
                <label for="variable-name">Name *</label>
                <input type="text" id="variable-name" name="name" required placeholder="e.g., API_KEY, DATABASE_URL">
            </div>

            <div class="form-group">
                <label for="variable-value">Value *</label>
                <textarea id="variable-value" name="value" required rows="3" placeholder="Variable value"></textarea>
            </div>

            <div class="form-group">
                <label for="variable-scope">Scope *</label>
                <select id="variable-scope" name="scope_type" required>
                    <option value="Global">Global (available to all jobs)</option>
                    <option value="Job">Job-Specific</option>
                </select>
            </div>

            <div class="form-group" id="job-selector" style="display: none;">
                <label for="variable-job">Job</label>
                <select id="variable-job" name="scope_id">
                    <option value="">Select a job...</option>
                </select>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="variable-sensitive" name="is_sensitive">
                    <span>Sensitive (encrypt at rest, mask in UI)</span>
                </label>
            </div>

            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeVariableModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Variable</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('variable-scope').addEventListener('change', function () {
        const jobSelector = document.getElementById('job-selector');
        if (this.value === 'Job') {
            jobSelector.style.display = 'block';
            document.getElementById('variable-job').required = true;
        } else {
            jobSelector.style.display = 'none';
            document.getElementById('variable-job').required = false;
        }
    });

    function showCreateVariableForm() {
        document.getElementById('modal-title').textContent = 'Create Variable';
        document.getElementById('variable-form').setAttribute('hx-post', '/api/variables');
        document.getElementById('variable-form').removeAttribute('hx-put');
        document.getElementById('variable-id').value = '';
        document.getElementById('variable-name').value = '';
        document.getElementById('variable-value').value = '';
        document.getElementById('variable-scope').value = 'Global';
        document.getElementById('variable-sensitive').checked = false;
        document.getElementById('job-selector').style.display = 'none';
        document.getElementById('variable-modal').style.display = 'block';
    }

    function editVariable(id, name, value, isSensitive) {
        document.getElementById('modal-title').textContent = 'Edit Variable';
        const form = document.getElementById('variable-form');
        form.setAttribute('hx-put', `/api/variables/${id}`);
        form.removeAttribute('hx-post');
        document.getElementById('variable-id').value = id;
        document.getElementById('variable-name').value = name;
        document.getElementById('variable-value').value = isSensitive ? '' : value;
        document.getElementById('variable-sensitive').checked = isSensitive;
        document.getElementById('variable-modal').style.display = 'block';
    }

    function closeVariableModal() {
        document.getElementById('variable-modal').style.display = 'none';
    }

    document.body.addEventListener('htmx:afterRequest', function (evt) {
        if (evt.detail.successful && evt.detail.elt.id === 'variable-form') {
            closeVariableModal();
        }
    });
</script>