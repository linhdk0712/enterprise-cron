{% extends "layout.html" %}

{% block title %}Create Job - Vietnam Enterprise Cron{% endblock %}

{% block extra_styles %}
<style>
    .wizard {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    /* Improved wizard steps with better mobile support */
    .wizard-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
        overflow-x: auto;
        padding: 0.5rem 0;
    }

    .wizard-steps::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #ecf0f1;
        z-index: 0;
    }

    .wizard-step {
        flex: 1;
        min-width: 100px;
        text-align: center;
        position: relative;
        z-index: 1;
        cursor: pointer;
        transition: all 0.3s;
    }

    .wizard-step:hover .wizard-step-circle {
        transform: scale(1.1);
    }

    .wizard-step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ecf0f1;
        color: #7f8c8d;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .wizard-step.active .wizard-step-circle {
        background: #3498db;
        color: white;
        box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
    }

    .wizard-step.completed .wizard-step-circle {
        background: #27ae60;
        color: white;
    }

    .wizard-step.completed .wizard-step-circle::after {
        content: '‚úì';
        position: absolute;
    }

    .wizard-step-label {
        font-size: 0.85rem;
        color: #7f8c8d;
        white-space: nowrap;
    }

    .wizard-step.active .wizard-step-label {
        color: #2c3e50;
        font-weight: 600;
    }

    .wizard-content {
        display: none;
        animation: fadeIn 0.3s;
    }

    .wizard-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .wizard-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #ecf0f1;
        gap: 1rem;
    }

    /* Improved form layout */
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    /* Quick templates section */
    .quick-templates {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .quick-templates h4 {
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
    }

    .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .template-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        padding: 1rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }

    .template-card:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
    }

    .template-card-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .template-card-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .template-card-desc {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    /* Collapsible sections */
    .collapsible-section {
        border: 1px solid #ecf0f1;
        border-radius: 6px;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .collapsible-header {
        background: #f8f9fa;
        padding: 1rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.3s;
    }

    .collapsible-header:hover {
        background: #e9ecef;
    }

    .collapsible-header-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
    }

    .collapsible-icon {
        transition: transform 0.3s;
    }

    .collapsible-section.open .collapsible-icon {
        transform: rotate(180deg);
    }

    .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .collapsible-section.open .collapsible-content {
        max-height: 2000px;
        transition: max-height 0.5s ease-in;
    }

    .collapsible-body {
        padding: 1rem;
    }

    /* Improved step items */
    .step-item {
        background: #ffffff;
        padding: 1.5rem;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        margin-bottom: 1rem;
        transition: all 0.3s;
    }

    .step-item:hover {
        border-color: #3498db;
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
    }

    .step-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f8f9fa;
    }

    .step-item-header strong {
        font-size: 1.1rem;
        color: #2c3e50;
    }

    /* Improved JSON preview */
    .json-preview {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 1.5rem;
        border-radius: 8px;
        font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
        font-size: 0.85rem;
        max-height: 500px;
        overflow-y: auto;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* Better error messages */
    .error-message {
        color: #e74c3c;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #fee;
        border-left: 3px solid #e74c3c;
        border-radius: 4px;
    }

    /* Radio group improvements */
    .radio-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
    }

    .radio-option {
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 6px;
        border: 2px solid #e9ecef;
        cursor: pointer;
        transition: all 0.3s;
    }

    .radio-option:hover {
        border-color: #3498db;
        background: #e3f2fd;
    }

    .radio-option input[type="radio"]:checked+label {
        font-weight: 600;
        color: #3498db;
    }

    .radio-option input[type="radio"] {
        margin-right: 0.5rem;
    }

    /* Help text styling */
    .help-text {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.75rem;
        background: #e8f4f8;
        border-left: 3px solid #3498db;
        border-radius: 4px;
        margin: 1rem 0;
        font-size: 0.9rem;
        color: #2c3e50;
    }

    .help-text-icon {
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    /* Tooltips */
    .tooltip-trigger {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        cursor: help;
    }

    .tooltip-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #3498db;
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
    }

    /* Summary cards */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.25rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .summary-card-label {
        font-size: 0.85rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }

    .summary-card-value {
        font-size: 1.5rem;
        font-weight: 600;
    }

    .hidden {
        display: none !important;
    }

    input[type="checkbox"]:disabled+strong {
        color: #95a5a6;
        text-decoration: line-through;
    }

    input[type="checkbox"]:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
        .wizard-steps {
            justify-content: flex-start;
            gap: 0.5rem;
        }

        .wizard-step {
            min-width: 80px;
        }

        .wizard-step-label {
            font-size: 0.75rem;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .template-grid {
            grid-template-columns: 1fr;
        }

        .radio-group {
            grid-template-columns: 1fr;
        }

        .summary-grid {
            grid-template-columns: 1fr;
        }

        .wizard-actions {
            flex-direction: column;
        }

        .wizard-actions button {
            width: 100%;
        }
    }

    /* Loading state */
    .btn-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.7;
    }

    .btn-loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spinner 0.6s linear infinite;
    }

    @keyframes spinner {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>üöÄ Create New Job</h2>
        <button class="btn btn-secondary" onclick="window.history.back()">
            ‚Üê Back
        </button>
    </div>

    <form id="job-form" class="wizard">
        <!-- Quick Templates -->
        <div class="quick-templates">
            <h4>‚ö° Quick Start Templates</h4>
            <div class="template-grid">
                <div class="template-card" onclick="applyTemplate('api_call')">
                    <div class="template-card-icon">üåê</div>
                    <div class="template-card-title">API Call</div>
                    <div class="template-card-desc">Call external REST API</div>
                </div>
                <div class="template-card" onclick="applyTemplate('database')">
                    <div class="template-card-icon">üóÑÔ∏è</div>
                    <div class="template-card-title">Database Query</div>
                    <div class="template-card-desc">Run SQL queries</div>
                </div>
                <div class="template-card" onclick="applyTemplate('file_processing')">
                    <div class="template-card-icon">üìä</div>
                    <div class="template-card-title">File Processing</div>
                    <div class="template-card-desc">Process Excel/CSV files</div>
                </div>
                <div class="template-card" onclick="applyTemplate('sftp')">
                    <div class="template-card-icon">üìÅ</div>
                    <div class="template-card-title">SFTP Transfer</div>
                    <div class="template-card-desc">Upload/download files</div>
                </div>
            </div>
        </div>

        <!-- Wizard Steps -->
        <div class="wizard-steps">
            <div class="wizard-step active" data-step="1" onclick="goToStep(1)">
                <div class="wizard-step-circle">1</div>
                <div class="wizard-step-label">Basic Info</div>
            </div>
            <div class="wizard-step" data-step="2" onclick="goToStep(2)">
                <div class="wizard-step-circle">2</div>
                <div class="wizard-step-label">Schedule</div>
            </div>
            <div class="wizard-step" data-step="3" onclick="goToStep(3)">
                <div class="wizard-step-circle">3</div>
                <div class="wizard-step-label">Job Steps</div>
            </div>
            <div class="wizard-step" data-step="4" onclick="goToStep(4)">
                <div class="wizard-step-circle">4</div>
                <div class="wizard-step-label">Triggers</div>
            </div>
            <div class="wizard-step" data-step="5" onclick="goToStep(5)">
                <div class="wizard-step-circle">5</div>
                <div class="wizard-step-label">Review</div>
            </div>
        </div>

        <!-- Step 1: Basic Info -->
        <div class="wizard-content active" data-step="1">
            <h3>üìù Basic Information</h3>
            <div class="help-text">
                <span class="help-text-icon">üí°</span>
                <div>Start by giving your job a descriptive name and configure basic settings. These can be changed
                    later.</div>
            </div>

            <div class="form-group">
                <label for="job-name">
                    Job Name *
                    <span class="tooltip-trigger">
                        <span class="tooltip-icon">?</span>
                    </span>
                </label>
                <input type="text" id="job-name" name="name" required placeholder="e.g., Daily Sales Report">
                <small style="color: #7f8c8d;">Choose a clear, descriptive name that explains what this job does</small>
                <span class="error-message hidden" id="error-name"></span>
            </div>

            <div class="form-group">
                <label for="job-description">Description</label>
                <textarea id="job-description" name="description" rows="3"
                    placeholder="Describe what this job does, when it runs, and any important details..."></textarea>
            </div>

            <!-- Advanced Settings (Collapsible) -->
            <div class="collapsible-section open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-header-title">
                        <span>‚öôÔ∏è</span>
                        <span>Advanced Settings</span>
                    </div>
                    <span class="collapsible-icon">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="timeout-seconds">
                                    Timeout (seconds) *
                                    <span class="tooltip-trigger">
                                        <span class="tooltip-icon">?</span>
                                    </span>
                                </label>
                                <input type="number" id="timeout-seconds" name="timeout_seconds" value="300" min="1"
                                    required>
                                <small style="color: #7f8c8d;">Maximum time allowed for job execution (default: 300s = 5
                                    minutes)</small>
                            </div>
                            <div class="form-group">
                                <label for="max-retries">
                                    Max Retries *
                                    <span class="tooltip-trigger">
                                        <span class="tooltip-icon">?</span>
                                    </span>
                                </label>
                                <input type="number" id="max-retries" name="max_retries" value="3" min="0" max="10"
                                    required>
                                <small style="color: #7f8c8d;">Number of retry attempts on failure (0-10, recommended:
                                    3)</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="allow-concurrent" name="allow_concurrent">
                                <strong>Allow concurrent executions</strong>
                            </label>
                            <small style="color: #7f8c8d; display: block; margin-left: 1.5rem;">
                                ‚ö†Ô∏è Enable only if multiple instances can run safely at the same time
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Schedule -->
        <div class="wizard-content" data-step="2">
            <h3>‚è∞ Schedule Configuration</h3>
            <div class="help-text">
                <span class="help-text-icon">üí°</span>
                <div>Choose how and when this job should run automatically. You can always trigger it manually
                    regardless of the schedule.</div>
            </div>

            <div class="form-group">
                <label><strong>Schedule Type *</strong></label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" id="schedule-none" name="schedule_type" value="none" checked>
                        <div>
                            <div><strong>üéØ Manual Only</strong></div>
                            <small>Trigger via dashboard or API</small>
                        </div>
                    </label>
                    <label class="radio-option">
                        <input type="radio" id="schedule-cron" name="schedule_type" value="cron">
                        <div>
                            <div><strong>üìÖ Cron Expression</strong></div>
                            <small>Complex schedules (e.g., daily at 2 AM)</small>
                        </div>
                    </label>
                    <label class="radio-option">
                        <input type="radio" id="schedule-fixed-delay" name="schedule_type" value="fixed_delay">
                        <div>
                            <div><strong>‚è±Ô∏è Fixed Delay</strong></div>
                            <small>Wait X seconds after completion</small>
                        </div>
                    </label>
                    <label class="radio-option">
                        <input type="radio" id="schedule-fixed-rate" name="schedule_type" value="fixed_rate">
                        <div>
                            <div><strong>üîÑ Fixed Rate</strong></div>
                            <small>Run every X seconds</small>
                        </div>
                    </label>
                    <label class="radio-option">
                        <input type="radio" id="schedule-one-time" name="schedule_type" value="one_time">
                        <div>
                            <div><strong>üéØ One Time</strong></div>
                            <small>Run once at specific time</small>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Cron Schedule -->
            <div id="cron-config" class="hidden">
                <div class="form-group">
                    <label for="cron-expression">Cron Expression *</label>
                    <input type="text" id="cron-expression" placeholder="0 0 0 * * ? *">
                    <small style="color: #7f8c8d;">Quartz syntax with second precision. Example: 0 0 0 * * ? * (daily at
                        midnight)</small>
                    <span class="error-message" id="error-cron-expression"></span>
                </div>
                <div class="form-group">
                    <label for="cron-timezone">Timezone</label>
                    <input type="text" id="cron-timezone" value="Asia/Ho_Chi_Minh" placeholder="Asia/Ho_Chi_Minh">
                </div>
                <div class="form-group">
                    <label for="cron-end-date">End Date (optional)</label>
                    <input type="datetime-local" id="cron-end-date">
                </div>
            </div>

            <!-- Fixed Delay Schedule -->
            <div id="fixed-delay-config" class="hidden">
                <div class="form-group">
                    <label for="delay-seconds">Delay (seconds) *</label>
                    <input type="number" id="delay-seconds" min="1" placeholder="3600">
                    <small style="color: #7f8c8d;">Time to wait after previous execution completes</small>
                </div>
            </div>

            <!-- Fixed Rate Schedule -->
            <div id="fixed-rate-config" class="hidden">
                <div class="form-group">
                    <label for="interval-seconds">Interval (seconds) *</label>
                    <input type="number" id="interval-seconds" min="1" placeholder="3600">
                    <small style="color: #7f8c8d;">Fixed interval between execution starts</small>
                </div>
            </div>

            <!-- One Time Schedule -->
            <div id="one-time-config" class="hidden">
                <div class="form-group">
                    <label for="execute-at">Execute At *</label>
                    <input type="datetime-local" id="execute-at">
                </div>
            </div>
        </div>

        <!-- Step 3: Job Steps -->
        <div class="wizard-content" data-step="3">
            <h3>üîß Job Steps</h3>
            <div class="help-text">
                <span class="help-text-icon">üí°</span>
                <div>Define the steps that will be executed sequentially. Each step can perform different operations
                    like API calls, database queries, or file processing.</div>
            </div>

            <div id="steps-container"></div>

            <button type="button" class="btn btn-primary" onclick="addStep()" style="width: 100%; margin-top: 1rem;">
                ‚ûï Add Step
            </button>
            <div id="steps-validation-error" class="error-message hidden" style="margin-top: 1rem;"></div>
        </div>

        <!-- Step 4: Triggers -->
        <div class="wizard-content" data-step="4">
            <h3>üéØ Trigger Configuration</h3>
            <div class="help-text">
                <span class="help-text-icon">üí°</span>
                <div>Configure how this job can be triggered. You can enable multiple trigger types for maximum
                    flexibility.</div>
            </div>

            <div class="collapsible-section open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-header-title">
                        <span>‚è∞</span>
                        <span>Scheduled Trigger</span>
                    </div>
                    <span class="collapsible-icon">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="trigger-scheduled" name="trigger_scheduled" checked>
                                <strong>Enable Scheduled Trigger</strong>
                            </label>
                            <small style="color: #7f8c8d; display: block; margin-left: 1.5rem;">
                                Automatically run based on schedule configuration (Step 2). Only works if you configured
                                a schedule.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-header-title">
                        <span>üëÜ</span>
                        <span>Manual Trigger</span>
                    </div>
                    <span class="collapsible-icon">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="trigger-manual" name="trigger_manual" checked>
                                <strong>Enable Manual Trigger</strong>
                            </label>
                            <small style="color: #7f8c8d; display: block; margin-left: 1.5rem;">
                                ‚úÖ Recommended - Allows you to trigger the job on-demand via dashboard or API
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-header-title">
                        <span>üîó</span>
                        <span>Webhook Trigger</span>
                    </div>
                    <span class="collapsible-icon">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="trigger-webhook" name="trigger_webhook">
                                <strong>Enable Webhook Trigger</strong>
                            </label>
                            <small style="color: #7f8c8d; display: block; margin-left: 1.5rem;">
                                Allows external systems to trigger this job via authenticated HTTP webhook
                            </small>
                        </div>
                        <div id="webhook-config" class="hidden" style="margin-top: 1rem;">
                            <div class="form-group">
                                <label for="webhook-secret">Webhook Secret Key *</label>
                                <input type="text" id="webhook-secret"
                                    placeholder="Enter a secret key for HMAC signature validation">
                                <small style="color: #7f8c8d;">Used for HMAC-SHA256 signature validation</small>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="webhook-rate-limit-max">Rate Limit - Max Requests</label>
                                    <input type="number" id="webhook-rate-limit-max" min="1" placeholder="100">
                                </div>
                                <div class="form-group">
                                    <label for="webhook-rate-limit-window">Rate Limit - Window (seconds)</label>
                                    <input type="number" id="webhook-rate-limit-window" min="1" placeholder="60">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 5: Review -->
        <div class="wizard-content" data-step="5">
            <h3>‚úÖ Review & Submit</h3>
            <div class="help-text">
                <span class="help-text-icon">üí°</span>
                <div>Review your job configuration before creating it. You can go back to any step to make changes.
                </div>
            </div>

            <div id="job-summary" class="summary-grid">
                <!-- Will be populated by JavaScript -->
            </div>

            <div class="collapsible-section open">
                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                    <div class="collapsible-header-title">
                        <span>üìÑ</span>
                        <span>JSON Configuration</span>
                    </div>
                    <span class="collapsible-icon">‚ñº</span>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-body">
                        <p style="color: #7f8c8d; margin-bottom: 1rem;">
                            This is the JSON that will be sent to the server. You can copy this for backup or API usage.
                        </p>
                        <div class="json-preview" id="json-preview"></div>
                    </div>
                </div>
            </div>

            <div id="validation-errors" class="alert alert-error hidden" style="margin-top: 1rem;"></div>
        </div>

        <!-- Wizard Actions -->
        <div class="wizard-actions">
            <button type="button" class="btn btn-secondary" id="btn-prev" onclick="previousStep()"
                style="display: none;">
                ‚Üê Previous
            </button>
            <div style="flex: 1;"></div>
            <button type="button" class="btn btn-primary" id="btn-next" onclick="nextStep()">
                Next ‚Üí
            </button>
            <button type="submit" class="btn btn-success" id="btn-submit" style="display: none;">
                ‚úì Create Job
            </button>
        </div>
    </form>
</div>

<script>
    let currentStep = 1;
    const totalSteps = 5;
    let steps = [];

    // Initialize form
    document.addEventListener('DOMContentLoaded', function () {
        // Schedule type change handlers
        document.querySelectorAll('input[name="schedule_type"]').forEach(radio => {
            radio.addEventListener('change', handleScheduleTypeChange);
        });

        // Webhook trigger change handler
        document.getElementById('trigger-webhook').addEventListener('change', function () {
            document.getElementById('webhook-config').classList.toggle('hidden', !this.checked);
        });

        // Form submission
        document.getElementById('job-form').addEventListener('submit', handleSubmit);

        // Auto-add first step for better UX
        addStep();
    });

    // Template functions
    function applyTemplate(templateType) {
        // Clear existing steps
        steps = [];
        document.getElementById('steps-container').innerHTML = '';

        // Apply template based on type
        if (templateType === 'api_call') {
            document.getElementById('job-name').value = 'API Call Job';
            document.getElementById('job-description').value = 'Call external REST API endpoint';
            addStep();
            setTimeout(() => {
                const stepEl = document.getElementById('step-1');
                stepEl.querySelector('.step-name').value = 'Call API';
                stepEl.querySelector('.step-type').value = 'http_request';
                handleStepTypeChange('step-1', 'http_request');
            }, 100);
        } else if (templateType === 'database') {
            document.getElementById('job-name').value = 'Database Query Job';
            document.getElementById('job-description').value = 'Execute SQL query on database';
            addStep();
            setTimeout(() => {
                const stepEl = document.getElementById('step-1');
                stepEl.querySelector('.step-name').value = 'Run Query';
                stepEl.querySelector('.step-type').value = 'database_query';
                handleStepTypeChange('step-1', 'database_query');
            }, 100);
        } else if (templateType === 'file_processing') {
            document.getElementById('job-name').value = 'File Processing Job';
            document.getElementById('job-description').value = 'Process Excel or CSV files';
            addStep();
            setTimeout(() => {
                const stepEl = document.getElementById('step-1');
                stepEl.querySelector('.step-name').value = 'Process File';
                stepEl.querySelector('.step-type').value = 'file_processing';
                handleStepTypeChange('step-1', 'file_processing');
            }, 100);
        } else if (templateType === 'sftp') {
            document.getElementById('job-name').value = 'SFTP Transfer Job';
            document.getElementById('job-description').value = 'Upload or download files via SFTP';
            addStep();
            setTimeout(() => {
                const stepEl = document.getElementById('step-1');
                stepEl.querySelector('.step-name').value = 'Transfer File';
                stepEl.querySelector('.step-type').value = 'sftp';
                handleStepTypeChange('step-1', 'sftp');
            }, 100);
        }

        // Show notification
        showNotification('Template applied! Review and customize the settings.', 'success');
    }

    // Collapsible section toggle
    function toggleCollapsible(header) {
        const section = header.parentElement;
        section.classList.toggle('open');
    }

    // Go to specific step (for clickable wizard steps)
    function goToStep(targetStep) {
        if (targetStep < currentStep) {
            // Allow going back
            while (currentStep > targetStep) {
                previousStep();
            }
        }
    }

    // Show notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.3s;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function handleScheduleTypeChange(e) {
        // Hide all schedule configs
        document.getElementById('cron-config').classList.add('hidden');
        document.getElementById('fixed-delay-config').classList.add('hidden');
        document.getElementById('fixed-rate-config').classList.add('hidden');
        document.getElementById('one-time-config').classList.add('hidden');

        // Show selected config
        const value = e.target.value;
        if (value === 'cron') {
            document.getElementById('cron-config').classList.remove('hidden');
        } else if (value === 'fixed_delay') {
            document.getElementById('fixed-delay-config').classList.remove('hidden');
        } else if (value === 'fixed_rate') {
            document.getElementById('fixed-rate-config').classList.remove('hidden');
        } else if (value === 'one_time') {
            document.getElementById('one-time-config').classList.remove('hidden');
        }

        // Auto-adjust trigger checkboxes based on schedule type
        const scheduledTrigger = document.getElementById('trigger-scheduled');
        const manualTrigger = document.getElementById('trigger-manual');

        if (value === 'none') {
            // Manual only - disable scheduled trigger, ensure manual is enabled
            scheduledTrigger.checked = false;
            scheduledTrigger.disabled = true;
            manualTrigger.checked = true;
        } else {
            // Has schedule - enable scheduled trigger
            scheduledTrigger.disabled = false;
            scheduledTrigger.checked = true;
        }
    }

    function nextStep() {
        if (!validateCurrentStep()) {
            return;
        }

        if (currentStep < totalSteps) {
            // Mark current step as completed
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('completed');
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.wizard-content[data-step="${currentStep}"]`).classList.remove('active');

            currentStep++;

            // Activate next step
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
            document.querySelector(`.wizard-content[data-step="${currentStep}"]`).classList.add('active');

            // Update buttons
            document.getElementById('btn-prev').style.display = 'block';
            if (currentStep === totalSteps) {
                document.getElementById('btn-next').style.display = 'none';
                document.getElementById('btn-submit').style.display = 'block';
                updateJsonPreview();
            }
        }
    }

    function previousStep() {
        if (currentStep > 1) {
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.wizard-content[data-step="${currentStep}"]`).classList.remove('active');

            currentStep--;

            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
            document.querySelector(`.wizard-content[data-step="${currentStep}"]`).classList.add('active');

            // Update buttons
            if (currentStep === 1) {
                document.getElementById('btn-prev').style.display = 'none';
            }
            document.getElementById('btn-next').style.display = 'block';
            document.getElementById('btn-submit').style.display = 'none';
        }
    }

    function validateCurrentStep() {
        // Clear previous errors
        document.querySelectorAll('.error-message').forEach(el => {
            el.textContent = '';
            el.classList.add('hidden');
        });

        if (currentStep === 1) {
            const name = document.getElementById('job-name').value.trim();
            if (!name) {
                const errorEl = document.getElementById('error-name');
                errorEl.textContent = '‚ö†Ô∏è Job name is required';
                errorEl.classList.remove('hidden');
                document.getElementById('job-name').focus();
                return false;
            }
        } else if (currentStep === 2) {
            const scheduleType = document.querySelector('input[name="schedule_type"]:checked').value;
            if (scheduleType === 'cron') {
                const expression = document.getElementById('cron-expression').value.trim();
                if (!expression) {
                    const errorEl = document.getElementById('error-cron-expression');
                    errorEl.textContent = '‚ö†Ô∏è Cron expression is required';
                    errorEl.classList.remove('hidden');
                    document.getElementById('cron-expression').focus();
                    return false;
                }
            } else if (scheduleType === 'fixed_delay') {
                const delay = document.getElementById('delay-seconds').value;
                if (!delay || delay < 1) {
                    showNotification('Delay seconds must be at least 1', 'error');
                    document.getElementById('delay-seconds').focus();
                    return false;
                }
            } else if (scheduleType === 'fixed_rate') {
                const interval = document.getElementById('interval-seconds').value;
                if (!interval || interval < 1) {
                    showNotification('Interval seconds must be at least 1', 'error');
                    document.getElementById('interval-seconds').focus();
                    return false;
                }
            } else if (scheduleType === 'one_time') {
                const executeAt = document.getElementById('execute-at').value;
                if (!executeAt) {
                    showNotification('Execute at time is required', 'error');
                    document.getElementById('execute-at').focus();
                    return false;
                }
            }
        } else if (currentStep === 3) {
            const stepsError = document.getElementById('steps-validation-error');
            if (steps.length === 0) {
                stepsError.textContent = '‚ö†Ô∏è At least one job step is required. Click "‚ûï Add Step" to add a step.';
                stepsError.classList.remove('hidden');
                return false;
            }

            // Validate each step has required fields
            for (let i = 0; i < steps.length; i++) {
                const stepEl = document.getElementById(steps[i].id);
                const stepName = stepEl.querySelector('.step-name').value.trim();
                const stepType = stepEl.querySelector('.step-type').value;

                if (!stepName) {
                    stepsError.textContent = `‚ö†Ô∏è Step ${i + 1}: Step name is required`;
                    stepsError.classList.remove('hidden');
                    stepEl.querySelector('.step-name').focus();
                    stepEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return false;
                }
                if (!stepType) {
                    stepsError.textContent = `‚ö†Ô∏è Step ${i + 1}: Step type is required`;
                    stepsError.classList.remove('hidden');
                    stepEl.querySelector('.step-type').focus();
                    stepEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return false;
                }
            }
            stepsError.classList.add('hidden');
        }

        return true;
    }

    function addStep() {
        const stepId = `step-${steps.length + 1}`;
        const stepNumber = steps.length + 1;

        const stepHtml = `
        <div class="step-item" id="${stepId}">
            <div class="step-item-header">
                <strong>Step ${stepNumber}</strong>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeStep('${stepId}')">Remove</button>
            </div>
            <div class="form-group">
                <label>Step Name *</label>
                <input type="text" class="step-name" placeholder="e.g., Fetch data from API" required>
            </div>
            <div class="form-group">
                <label>Step Type *</label>
                <select class="step-type" onchange="handleStepTypeChange('${stepId}', this.value)">
                    <option value="">Select type...</option>
                    <option value="http_request">HTTP Request</option>
                    <option value="database_query">Database Query</option>
                    <option value="file_processing">File Processing</option>
                    <option value="sftp">SFTP</option>
                </select>
            </div>
            <div class="step-config" id="${stepId}-config"></div>
        </div>
    `;

        document.getElementById('steps-container').insertAdjacentHTML('beforeend', stepHtml);
        steps.push({ id: stepId, number: stepNumber });
    }

    function removeStep(stepId) {
        document.getElementById(stepId).remove();
        steps = steps.filter(s => s.id !== stepId);
        // Renumber remaining steps
        steps.forEach((step, index) => {
            step.number = index + 1;
            const element = document.getElementById(step.id);
            element.querySelector('.step-item-header strong').textContent = `Step ${step.number}`;
        });
    }

    function handleStepTypeChange(stepId, type) {
        const configDiv = document.getElementById(`${stepId}-config`);
        configDiv.innerHTML = '';

        if (type === 'http_request') {
            configDiv.innerHTML = `
            <div class="form-group">
                <label>HTTP Method *</label>
                <select class="http-method">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                </select>
            </div>
            <div class="form-group">
                <label>URL *</label>
                <input type="text" class="http-url" placeholder="https://api.example.com/endpoint">
            </div>
            <div class="form-group">
                <label>Headers (JSON)</label>
                <textarea class="http-headers" rows="3" placeholder='{"Content-Type": "application/json"}'></textarea>
            </div>
            <div class="form-group">
                <label>Body (JSON)</label>
                <textarea class="http-body" rows="3" placeholder='{"key": "value"}'></textarea>
            </div>
            <div class="form-group">
                <label>Authentication</label>
                <select class="http-auth-type" onchange="handleHttpAuthChange('${stepId}', this.value)">
                    <option value="">None</option>
                    <option value="basic">Basic</option>
                    <option value="bearer">Bearer Token</option>
                    <option value="oauth2">OAuth2</option>
                </select>
            </div>
            <div class="http-auth-config" id="${stepId}-http-auth"></div>
        `;
        } else if (type === 'database_query') {
            configDiv.innerHTML = `
            <div class="form-group">
                <label>Database Type *</label>
                <select class="db-type">
                    <option value="postgresql">PostgreSQL</option>
                    <option value="mysql">MySQL</option>
                    <option value="oracle">Oracle</option>
                </select>
            </div>
            <div class="form-group">
                <label>Connection String *</label>
                <input type="text" class="db-connection" placeholder="postgresql://user:pass@host:5432/db">
            </div>
            <div class="form-group">
                <label>Query Type *</label>
                <select class="db-query-type" onchange="handleDbQueryTypeChange('${stepId}', this.value)">
                    <option value="raw_sql">Raw SQL</option>
                    <option value="stored_procedure">Stored Procedure</option>
                </select>
            </div>
            <div class="form-group">
                <label>SQL Query *</label>
                <textarea class="db-query" rows="4" placeholder="SELECT * FROM users WHERE id = $1"></textarea>
            </div>
            <div class="db-sp-config hidden" id="${stepId}-db-sp">
                <div class="form-group">
                    <label>Procedure Name *</label>
                    <input type="text" class="db-sp-name" placeholder="get_user_data">
                </div>
                <div class="form-group">
                    <label>Parameters (comma-separated)</label>
                    <input type="text" class="db-sp-params" placeholder="param1, param2">
                </div>
            </div>
        `;
        } else if (type === 'file_processing') {
            configDiv.innerHTML = `
            <div class="form-group">
                <label>Operation *</label>
                <select class="file-operation">
                    <option value="read">Read</option>
                    <option value="write">Write</option>
                </select>
            </div>
            <div class="form-group">
                <label>File Format *</label>
                <select class="file-format" onchange="handleFileFormatChange('${stepId}', this.value)">
                    <option value="excel">Excel (XLSX)</option>
                    <option value="csv">CSV</option>
                </select>
            </div>
            <div class="csv-delimiter hidden" id="${stepId}-csv-delimiter">
                <div class="form-group">
                    <label>CSV Delimiter</label>
                    <select class="csv-delimiter-char">
                        <option value=",">Comma (,)</option>
                        <option value=";">Semicolon (;)</option>
                        <option value="\\t">Tab</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Source Path</label>
                <input type="text" class="file-source" placeholder="jobs/{job_id}/input/data.xlsx">
            </div>
            <div class="form-group">
                <label>Destination Path</label>
                <input type="text" class="file-destination" placeholder="jobs/{job_id}/output/result.xlsx">
            </div>
            <div class="form-group">
                <label>Sheet Name (Excel only)</label>
                <input type="text" class="file-sheet-name" placeholder="Sheet1">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" class="file-streaming">
                    Use streaming for large files (>100MB)
                </label>
            </div>
        `;
        } else if (type === 'sftp') {
            configDiv.innerHTML = `
            <div class="form-group">
                <label>Operation *</label>
                <select class="sftp-operation">
                    <option value="download">Download</option>
                    <option value="upload">Upload</option>
                </select>
            </div>
            <div class="form-group">
                <label>Host *</label>
                <input type="text" class="sftp-host" placeholder="sftp.example.com">
            </div>
            <div class="form-group">
                <label>Port *</label>
                <input type="number" class="sftp-port" value="22" min="1" max="65535">
            </div>
            <div class="form-group">
                <label>Authentication Type *</label>
                <select class="sftp-auth-type" onchange="handleSftpAuthChange('${stepId}', this.value)">
                    <option value="password">Password</option>
                    <option value="ssh_key">SSH Key</option>
                </select>
            </div>
            <div class="sftp-auth-config" id="${stepId}-sftp-auth">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" class="sftp-username" placeholder="username">
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" class="sftp-password" placeholder="password">
                </div>
            </div>
            <div class="form-group">
                <label>Remote Path *</label>
                <input type="text" class="sftp-remote-path" placeholder="/path/to/file.csv">
            </div>
            <div class="form-group">
                <label>Local Path (MinIO)</label>
                <input type="text" class="sftp-local-path" placeholder="jobs/{job_id}/files/data.csv">
            </div>
            <div class="form-group">
                <label>Wildcard Pattern</label>
                <input type="text" class="sftp-wildcard" placeholder="*.csv">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" class="sftp-recursive">
                    Recursive (for directories)
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" class="sftp-create-dirs" checked>
                    Create remote directories if needed
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" class="sftp-verify-host" checked>
                    Verify host key
                </label>
            </div>
        `;
        }
    }

    function handleHttpAuthChange(stepId, authType) {
        const authDiv = document.getElementById(`${stepId}-http-auth`);
        if (authType === 'basic') {
            authDiv.innerHTML = `
            <div class="form-group">
                <label>Username *</label>
                <input type="text" class="http-auth-username">
            </div>
            <div class="form-group">
                <label>Password *</label>
                <input type="password" class="http-auth-password">
            </div>
        `;
        } else if (authType === 'bearer') {
            authDiv.innerHTML = `
            <div class="form-group">
                <label>Token *</label>
                <input type="text" class="http-auth-token">
            </div>
        `;
        } else if (authType === 'oauth2') {
            authDiv.innerHTML = `
            <div class="form-group">
                <label>Client ID *</label>
                <input type="text" class="http-auth-client-id">
            </div>
            <div class="form-group">
                <label>Client Secret *</label>
                <input type="password" class="http-auth-client-secret">
            </div>
            <div class="form-group">
                <label>Token URL *</label>
                <input type="text" class="http-auth-token-url" placeholder="https://auth.example.com/token">
            </div>
        `;
        } else {
            authDiv.innerHTML = '';
        }
    }

    function handleDbQueryTypeChange(stepId, queryType) {
        const spConfig = document.getElementById(`${stepId}-db-sp`);
        if (queryType === 'stored_procedure') {
            spConfig.classList.remove('hidden');
        } else {
            spConfig.classList.add('hidden');
        }
    }

    function handleFileFormatChange(stepId, format) {
        const csvDelimiter = document.getElementById(`${stepId}-csv-delimiter`);
        if (format === 'csv') {
            csvDelimiter.classList.remove('hidden');
        } else {
            csvDelimiter.classList.add('hidden');
        }
    }

    function handleSftpAuthChange(stepId, authType) {
        const authDiv = document.getElementById(`${stepId}-sftp-auth`);
        if (authType === 'password') {
            authDiv.innerHTML = `
            <div class="form-group">
                <label>Username *</label>
                <input type="text" class="sftp-username" placeholder="username">
            </div>
            <div class="form-group">
                <label>Password *</label>
                <input type="password" class="sftp-password" placeholder="password">
            </div>
        `;
        } else if (authType === 'ssh_key') {
            authDiv.innerHTML = `
            <div class="form-group">
                <label>Username *</label>
                <input type="text" class="sftp-username" placeholder="username">
            </div>
            <div class="form-group">
                <label>Private Key Path *</label>
                <input type="text" class="sftp-key-path" placeholder="/path/to/private_key">
            </div>
        `;
        }
    }

    function buildJobDefinition() {
        const jobDef = {
            name: document.getElementById('job-name').value.trim(),
            description: document.getElementById('job-description').value.trim() || null,
            timeout_seconds: parseInt(document.getElementById('timeout-seconds').value),
            max_retries: parseInt(document.getElementById('max-retries').value),
            allow_concurrent: document.getElementById('allow-concurrent').checked,
            schedule: null,
            steps: [],
            triggers: {
                scheduled: document.getElementById('trigger-scheduled').checked,
                manual: document.getElementById('trigger-manual').checked,
                webhook: null
            }
        };

        // Build schedule
        const scheduleType = document.querySelector('input[name="schedule_type"]:checked').value;
        if (scheduleType !== 'none') {
            if (scheduleType === 'cron') {
                jobDef.schedule = {
                    type: 'cron',
                    expression: document.getElementById('cron-expression').value.trim(),
                    timezone: document.getElementById('cron-timezone').value.trim() || 'Asia/Ho_Chi_Minh',
                    end_date: document.getElementById('cron-end-date').value || null
                };
            } else if (scheduleType === 'fixed_delay') {
                jobDef.schedule = {
                    type: 'fixed_delay',
                    delay_seconds: parseInt(document.getElementById('delay-seconds').value)
                };
            } else if (scheduleType === 'fixed_rate') {
                jobDef.schedule = {
                    type: 'fixed_rate',
                    interval_seconds: parseInt(document.getElementById('interval-seconds').value)
                };
            } else if (scheduleType === 'one_time') {
                jobDef.schedule = {
                    type: 'one_time',
                    execute_at: document.getElementById('execute-at').value
                };
            }
        }

        // Build steps
        steps.forEach((step, index) => {
            const stepEl = document.getElementById(step.id);
            const stepName = stepEl.querySelector('.step-name').value.trim();
            const stepType = stepEl.querySelector('.step-type').value;

            if (!stepName || !stepType) return;

            // Build step with flat type structure (serde tagged enum)
            const stepDef = {
                id: `step${index + 1}`,
                name: stepName,
                condition: null
            };

            if (stepType === 'http_request') {
                const method = stepEl.querySelector('.http-method').value;
                const url = stepEl.querySelector('.http-url').value.trim();
                const headersText = stepEl.querySelector('.http-headers').value.trim();
                const bodyText = stepEl.querySelector('.http-body').value.trim();
                const authType = stepEl.querySelector('.http-auth-type').value;

                let headers = {};
                if (headersText) {
                    try {
                        headers = JSON.parse(headersText);
                    } catch (e) {
                        console.error('Invalid headers JSON:', e);
                    }
                }

                let auth = null;
                if (authType === 'basic') {
                    auth = {
                        type: 'basic',
                        username: stepEl.querySelector('.http-auth-username').value,
                        password: stepEl.querySelector('.http-auth-password').value
                    };
                } else if (authType === 'bearer') {
                    auth = {
                        type: 'bearer',
                        token: stepEl.querySelector('.http-auth-token').value
                    };
                } else if (authType === 'oauth2') {
                    auth = {
                        type: 'oauth2',
                        client_id: stepEl.querySelector('.http-auth-client-id').value,
                        client_secret: stepEl.querySelector('.http-auth-client-secret').value,
                        token_url: stepEl.querySelector('.http-auth-token-url').value
                    };
                }

                // Flat structure for serde tagged enum
                stepDef.type = {
                    type: 'http_request',
                    method: method,
                    url: url,
                    headers: headers,
                    body: bodyText || null,
                    auth: auth
                };
            } else if (stepType === 'database_query') {
                const dbType = stepEl.querySelector('.db-type').value;
                const connection = stepEl.querySelector('.db-connection').value.trim();
                const query = stepEl.querySelector('.db-query').value.trim();
                const queryType = stepEl.querySelector('.db-query-type').value;

                let queryTypeObj = { type: 'raw_sql' };
                if (queryType === 'stored_procedure') {
                    const spName = stepEl.querySelector('.db-sp-name').value.trim();
                    const spParams = stepEl.querySelector('.db-sp-params').value.trim();
                    queryTypeObj = {
                        type: 'stored_procedure',
                        procedure_name: spName,
                        parameters: spParams ? spParams.split(',').map(p => p.trim()) : []
                    };
                }

                stepDef.type = {
                    type: 'database_query',
                    database_type: dbType,  // postgresql, mysql, oracle (lowercase)
                    connection_string: connection,
                    query: query,
                    query_type: queryTypeObj
                };
            } else if (stepType === 'file_processing') {
                const operation = stepEl.querySelector('.file-operation').value;
                const format = stepEl.querySelector('.file-format').value;
                const source = stepEl.querySelector('.file-source').value.trim();
                const destination = stepEl.querySelector('.file-destination').value.trim();
                const sheetName = stepEl.querySelector('.file-sheet-name').value.trim();
                const streaming = stepEl.querySelector('.file-streaming').checked;

                let formatObj = { type: 'excel' };
                if (format === 'csv') {
                    const delimiter = stepEl.querySelector('.csv-delimiter-char').value;
                    formatObj = {
                        type: 'csv',
                        delimiter: delimiter === '\\t' ? '\t' : delimiter
                    };
                }

                stepDef.type = {
                    type: 'file_processing',
                    operation: operation,
                    format: formatObj,
                    source_path: source || null,
                    destination_path: destination || null,
                    options: {
                        sheet_name: sheetName || null,
                        sheet_index: null,
                        transformations: [],
                        streaming: streaming
                    }
                };
            }
            else if (stepType === 'sftp') {
                const operation = stepEl.querySelector('.sftp-operation').value;
                const host = stepEl.querySelector('.sftp-host').value.trim();
                const port = parseInt(stepEl.querySelector('.sftp-port').value);
                const authType = stepEl.querySelector('.sftp-auth-type').value;
                const remotePath = stepEl.querySelector('.sftp-remote-path').value.trim();
                const localPath = stepEl.querySelector('.sftp-local-path').value.trim();
                const wildcard = stepEl.querySelector('.sftp-wildcard').value.trim();
                const recursive = stepEl.querySelector('.sftp-recursive').checked;
                const createDirs = stepEl.querySelector('.sftp-create-dirs').checked;
                const verifyHost = stepEl.querySelector('.sftp-verify-host').checked;

                let auth = null;
                if (authType === 'password') {
                    auth = {
                        type: 'password',
                        username: stepEl.querySelector('.sftp-username').value,
                        password: stepEl.querySelector('.sftp-password').value
                    };
                } else if (authType === 'ssh_key') {
                    auth = {
                        type: 'ssh_key',
                        username: stepEl.querySelector('.sftp-username').value,
                        private_key_path: stepEl.querySelector('.sftp-key-path').value
                    };
                }

                stepDef.type = {
                    type: 'sftp',
                    operation: operation,
                    host: host,
                    port: port,
                    auth: auth,
                    remote_path: remotePath,
                    local_path: localPath || null,
                    options: {
                        wildcard_pattern: wildcard || null,
                        recursive: recursive,
                        create_directories: createDirs,
                        verify_host_key: verifyHost
                    }
                };
            }

            jobDef.steps.push(stepDef);
        });

        // Build webhook config
        if (document.getElementById('trigger-webhook').checked) {
            const secret = document.getElementById('webhook-secret').value.trim();
            const maxRequests = document.getElementById('webhook-rate-limit-max').value;
            const windowSeconds = document.getElementById('webhook-rate-limit-window').value;

            jobDef.triggers.webhook = {
                enabled: true,
                url: '', // Will be generated by backend
                secret_key: secret,
                rate_limit: (maxRequests && windowSeconds) ? {
                    max_requests: parseInt(maxRequests),
                    window_seconds: parseInt(windowSeconds)
                } : null
            };
        }

        return jobDef;
    }

    function updateJsonPreview() {
        const jobDef = buildJobDefinition();
        const jsonStr = JSON.stringify(jobDef, null, 2);
        document.getElementById('json-preview').textContent = jsonStr;

        // Update summary with cards
        const scheduleType = document.querySelector('input[name="schedule_type"]:checked').value;
        let scheduleText = '';
        let scheduleIcon = '';
        if (scheduleType === 'none') {
            scheduleText = 'Manual Only';
            scheduleIcon = 'üéØ';
        } else if (scheduleType === 'cron') {
            scheduleText = document.getElementById('cron-expression').value;
            scheduleIcon = 'üìÖ';
        } else if (scheduleType === 'fixed_delay') {
            scheduleText = `${document.getElementById('delay-seconds').value}s delay`;
            scheduleIcon = '‚è±Ô∏è';
        } else if (scheduleType === 'fixed_rate') {
            scheduleText = `Every ${document.getElementById('interval-seconds').value}s`;
            scheduleIcon = 'üîÑ';
        } else if (scheduleType === 'one_time') {
            scheduleText = document.getElementById('execute-at').value;
            scheduleIcon = 'üéØ';
        }

        const triggers = [];
        if (document.getElementById('trigger-scheduled').checked && scheduleType !== 'none') {
            triggers.push('Scheduled');
        }
        if (document.getElementById('trigger-manual').checked) {
            triggers.push('Manual');
        }
        if (document.getElementById('trigger-webhook').checked) {
            triggers.push('Webhook');
        }

        document.getElementById('job-summary').innerHTML = `
            <div class="summary-card">
                <div class="summary-card-label">Job Name</div>
                <div class="summary-card-value">${jobDef.name}</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">${scheduleIcon} Schedule</div>
                <div class="summary-card-value" style="font-size: 1.1rem;">${scheduleText}</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">üîß Steps</div>
                <div class="summary-card-value">${jobDef.steps.length}</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">üéØ Triggers</div>
                <div class="summary-card-value" style="font-size: 1.1rem;">${triggers.join(', ')}</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">‚è±Ô∏è Timeout</div>
                <div class="summary-card-value">${jobDef.timeout_seconds}s</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-label">üîÑ Max Retries</div>
                <div class="summary-card-value">${jobDef.max_retries}</div>
            </div>
        `;
    }

    async function handleSubmit(e) {
        e.preventDefault();

        const jobDef = buildJobDefinition();
        const submitBtn = document.getElementById('btn-submit');

        // Client-side validation
        const errors = [];
        if (!jobDef.name) {
            errors.push('Job name is required');
        }
        if (jobDef.steps.length === 0) {
            errors.push('At least one job step is required');
        }

        if (errors.length > 0) {
            const errorDiv = document.getElementById('validation-errors');
            errorDiv.innerHTML = errors.map(e => `<div>‚ö†Ô∏è ${e}</div>`).join('');
            errorDiv.classList.remove('hidden');
            return;
        }

        // Show loading state
        submitBtn.classList.add('btn-loading');
        submitBtn.disabled = true;
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Creating...';

        try {
            // Get auth token from cookie
            const authToken = document.cookie
                .split('; ')
                .find(row => row.startsWith('auth_token='))
                ?.split('=')[1];

            const headers = {
                'Content-Type': 'application/json',
            };

            // Add Authorization header if token exists
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            const response = await fetch('/api/jobs', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(jobDef)
            });

            const result = await response.json();

            if (response.ok) {
                showNotification('Job created successfully!', 'success');
                setTimeout(() => {
                    window.location.href = `/dashboard/jobs/${result.data}`;
                }, 1000);
            } else {
                const errorDiv = document.getElementById('validation-errors');
                const errorMsg = result.error || result.message || 'Failed to create job';
                errorDiv.innerHTML = `<div><strong>‚ùå Error:</strong> ${errorMsg}</div>`;
                if (result.details) {
                    errorDiv.innerHTML += `<div style="margin-top: 0.5rem;"><small>${result.details}</small></div>`;
                }
                errorDiv.classList.remove('hidden');
                showNotification('Failed to create job', 'error');

                // Reset button
                submitBtn.classList.remove('btn-loading');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        } catch (error) {
            const errorDiv = document.getElementById('validation-errors');
            errorDiv.innerHTML = `<div><strong>‚ùå Error:</strong> ${error.message}</div>`;
            errorDiv.classList.remove('hidden');
            showNotification('Network error occurred', 'error');

            // Reset button
            submitBtn.classList.remove('btn-loading');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    }
</script>
{% endblock %}